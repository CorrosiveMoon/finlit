version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0-jammy
    container_name: financial_literacy_db
    restart: unless-stopped
    
    # Security: Run as non-root user
    user: mongodb
    
    environment:
      # MongoDB Authentication
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: financial-literacy
      # App user credentials (needed by init script)
      MONGO_APP_USER: ${MONGO_APP_USER:-app_user}
      MONGO_APP_PASSWORD: ${MONGO_APP_PASSWORD}
    
    volumes:
      # Persistent data storage
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      # MongoDB initialization script
      - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    
    # Security: Only expose to internal network
    # Do NOT expose ports publicly in production
    # ports:
    #   - "27017:27017"  # Only uncomment for local debugging
    
    networks:
      - app_network
    
    # Resource limits for stability
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 512M
    
    # Health check
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/financial-literacy --quiet
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem for security
    # (MongoDB needs to write to /tmp and /data)
    tmpfs:
      - /tmp

  # Next.js Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
        # Pass Clerk keys as build arguments for static generation
        NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
        CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
        NEXT_PUBLIC_CLERK_SIGN_IN_URL: ${NEXT_PUBLIC_CLERK_SIGN_IN_URL:-/sign-in}
        NEXT_PUBLIC_CLERK_SIGN_UP_URL: ${NEXT_PUBLIC_CLERK_SIGN_UP_URL:-/sign-up}
        NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: ${NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL:-/budget}
        NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: ${NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL:-/budget}
    
    container_name: financial_literacy_app
    restart: unless-stopped
    
    # Port mapping
    ports:
      - "${APP_PORT:-3000}:3000"
    
    environment:
      # MongoDB connection (internal Docker network)
      MONGODB_URI: mongodb://${MONGO_APP_USER:-app_user}:${MONGO_APP_PASSWORD}@mongodb:27017/financial-literacy?authSource=financial-literacy
      
      # Clerk Authentication (from .env)
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      NEXT_PUBLIC_CLERK_SIGN_IN_URL: ${NEXT_PUBLIC_CLERK_SIGN_IN_URL:-/sign-in}
      NEXT_PUBLIC_CLERK_SIGN_UP_URL: ${NEXT_PUBLIC_CLERK_SIGN_UP_URL:-/sign-up}
      NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: ${NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL:-/budget}
      NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: ${NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL:-/budget}
      
      # Node environment
      NODE_ENV: production
    
    depends_on:
      mongodb:
        condition: service_healthy
    
    networks:
      - app_network
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem
    read_only: true
    tmpfs:
      - /tmp
      - /app/.next/cache
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 256M

# Networks
networks:
  app_network:
    driver: bridge
    # Network isolation
    internal: false  # Set to true if you don't need external access

# Volumes for data persistence
volumes:
  mongodb_data:
    driver: local
    # For GCP, consider using a named volume with backup strategy
  mongodb_config:
    driver: local
